<!DOCTYPE html>	<html lang="en">		<head>		  <title>Oliver Marsh</title>		  <meta charset="utf-8">		  <meta name="viewport" content="width=device-width, initial-scale=1">		  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">		  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">		  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>		  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>		  <link rel="stylesheet" type="text/css" href="style.css">		</head><nav class="navbar navbar-default" style="background-color: white; color: #f5f6f7;">	  <div class="container">	    <div class="navbar-header">	      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">	        <span class="icon-bar"></span>	        <span class="icon-bar"></span>	        <span class="icon-bar"></span>	      </button>	      <a class="navbar-left" href="./index.html#"><img style="width: 7cm;" src="./photos/logo2.svg"></a>	    </div>	    <div class="collapse navbar-collapse" id="myNavbar">	      <ul class="nav navbar-nav navbar-right"  style="margin-top: 25px;">	        <li><a href="./index.html">Direct X</a></li>	      	<li><a href="./index.html">Games</a></li>	      	<li><a href="./about.html">About</a></li>	      </ul>	    </div>	  </div>	</nav>	<body>	<div class="container"><div class="row">
<div class="col-sm-10 col-md-12 col-lg-12">
<div class="info-card">
<h1>Windows Keyboard input</h1></div>
</div>
</div>
<div class="row">
<div class="col-sm-10 col-md-12 col-lg-12">
<div class="info-card">
<p>
Getting input from the player is the crucial for a game; without it it's not a game, it's a movie. So how do we get input from the user and what's the best way to keep track of it? </p>
<br><p>
In this article we're going to walk through getting input from the user's keyboard on Windows. We'll also go through how to store it and use it in our game. Let's Go!</p>
<br><hr><h2>Contents</h2><br><h4><a href='#id0'>Message Callback</a> </h4><br><h4><a href='#id1'>WM_KEYDOWN and WM_KEYUP messages</a> </h4><br><h4><a href='#id2'>Virtual Key Codes</a></h4><br><h4><a href='#id3'>Making an enum value for each key</a></h4><br><h4><a href='#id4'>Adding KeyPressed and KeyReleased</a></h4><br><h4><a href='#id5'>Multiple Key Presses and Releases Per Frame</a></h4><br><h4><a href='#id6'>Handling WM_SYSKEYDOWN and WM_SYSKEYUP</a></h4><br><h4><a href='#id7'>Using lparam instead of previous <i>isDown</i> value</a></h4><br><h4><a href='#id8'>Mouse Input</a></h4><br><h4><a href='#id9'>Get Cursor Coordinates</a></h4><br><h4><a href='#id10'>Platform Input Struct</a></h4><br><hr><h2><span id='id0'>Message Callback</span></h2><br><p>
The core of our input is in the WndProc message callback. This is the way the OS sends our program messages like if the user clicks the red cross button, resizes the window or presses buttons. It looks like this: </p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br><br></div><br><a target='_blank' href='https://docs.microsoft.com/en-us/windows/win32/learnwin32/writing-the-window-procedure'> You can read more about this function here.   ðŸ‘†</a><br><br><p>
When we create our window class we give it this function to send all messages through. Then when we process our messages in our game loop using <i>Peek Message</i>, our function will be called when we call <i>DispatchMessage</i>. <a href="./create_direct_x_11.html">This tutorial walks you through doing this.</a> </p>
<br><a target='_blank' href='https://github.com/Olster1/directX11_tutorial/blob/main/lesson1/main.cpp'> You can see what our basic program would look like using handling OS messages.  ðŸ‘†</a><br><br><h2><span id='id1'>WM_KEYDOWN and WM_KEYUP messages</span></h2><br><p>
We don't do anything yet with the messages we recieve, we just pass them to the default handler. We going to want to change that! </p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN || msg == WM_KEYUP<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: handle our keyboard input</span><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br></div><br><p>
We're also going to handle messages sent when the user closes the app. </p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_CLOSE || msg == WM_DESTROY<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: We handle this message in our game loop</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">PostQuitMessage</span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">0</span><span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN || msg == WM_KEYUP<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: handle our keyboard input</span><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br></div><br><p>
Using the message type, we can see what messages the OS has sent us. The two messages we want to handle is the WM_KEYDOWN and WM_KEYUP; these are messages for when the user presses, holds and releases a button. Using just these messages the user could control a character.  </p>
<br><hr><h2><span id='id2'>Virtual Key Codes</span></h2><br><p>
We now know when a user presses a key, next we need to know which key it was. This is called the <i>Virtual key code</i>. It's virtual because depending on the mapping of the user's keyboard it might not be the actual key they pressed, but the mapped value. The Virtual key code or VK code is the <i>wparam</i> value passed into the function. </p>
<br><a target='_blank' href='https://docs.microsoft.com/en-us/windows/win32/inputdev/virtual-key-codes'> You can see all the VK codes corresponding to the keys here ðŸ‘†</a><br><br><p>
Let's start with the Up, Down, Left and Right arrows.</p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN || msg == WM_KEYUP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: handle our keyboard input</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_UP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_DOWN<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_LEFT<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_RIGHT<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br></div><br><p>
Whenever the user presses, holds or releases an Arrow key we'll get a message here. Let's store this so the game logic can use it. Since the message callback function is isolated from our main function and we can't pass any custom parameters into it, we have to use a <b>global variable</b> store them. It would look like this:</p>
<br><div class="code-block-left "><span style="color: #CD950C;">static </span><span style="color: #6B8E23;">bool </span>global_keyDownStates[4];   <br><br>LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Handle our messages </span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">// ...  </span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>}<br><br></div><br><p>
We're using a bool to say whether the key is down or not, and each key mapped to an index in the array. </p>
<br><p>
In our callback we will set the values of this array. </p>
<br><div class="code-block-left "><span style="color: #CD950C;">static </span><span style="color: #6B8E23;">bool </span>global_keyDownStates[4];  <br><br>LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN || msg == WM_KEYUP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>keyDown <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: handle our keyboard input</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_UP<span style="color: #A08563;">)</span> {        <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[0] = keyDown;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_DOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[1] = keyDown;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_LEFT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[2] = keyDown;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_RIGHT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[3] = keyDown;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br></div><br><p>
When the user press the up arrow key a WM_KEYUP message will be sent. We then set the array value to true. It will stay true until the user releases the key, in that case a WM_KEYUP message will be sent and the value will be set to false. Awesome!</p>
<br><p>
In our game loop we could use this now to control a character:</p>
<br><div class="code-block-left "><span style="color: #6B8E23;">bool </span>running = true;<br><span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span>running<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;MSG message;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span><span style="color: #CD950C;">PeekMessage</span><span style="color: #A08563;">(</span>&message, <span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span>PM_REMOVE<span style="color: #A08563;">)</span><span style="color: #A08563;">)</span><br>&emsp;&emsp;&emsp;&emsp;{	<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>message.message == WM_QUIT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Exit our game loop</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;running = false;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">TranslateMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">DispatchMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>; <span style="color: #7D7D7D;">//NOTE: our message callback is handled here</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Use our global array to access the key down states </span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>global_keyDownStates[0]<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Move Character forward</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>global_keyDownStates[2]<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Move Character left</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>global_keyDownStates[3]<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Move Character right</span><br>&emsp;&emsp;&emsp;&emsp;}<br>}<br><br></div><br><hr><h2><span id='id3'>Making an enum value for each key</span></h2><br><p>
To make it easier to read and for us to less likely make a mistake, instead of using the array index directly, we'll make a enum value for each key we want to use:</p>
<br><div class="code-block-left "><span style="color: #CD950C;">enum </span>PlatformKeyType {<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_UP,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_DOWN,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_LEFT,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_RIGHT<br>};<br></div><br><p>
Then in our message loop we can use these instead of array indexes.</p>
<br><div class="code-block-left "><span style="color: #CD950C;">static </span><span style="color: #6B8E23;">bool </span>global_keyDownStates[4];  <br><br>LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN || msg == WM_KEYUP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>keyDown <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: handle our keyboard input</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_UP<span style="color: #A08563;">)</span> {        <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_KEY_UP] = keyDown;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_DOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_KEY_DOWN] = keyDown;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_LEFT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_KEY_LEFT] = keyDown;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>wparam == VK_RIGHT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_KEY_RIGHT] = keyDown;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br></div><br><p>
Great! If all our game wanted was whether the key was up or down, say a racing game, this would be it. We would just handle more of the keys we wanted in our callback. So we don't have to expand the global array each time we add a new key, we will make it based of the size of the number of enums. </p>
<br><div class="code-block-left "><span style="color: #CD950C;">enum </span>PlatformKeyType {<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_UP,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_DOWN,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_LEFT,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_RIGHT,<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Everthing before here</span><br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_TOTAL_COUNT<br>};<br><br><span style="color: #CD950C;">static </span><span style="color: #6B8E23;">bool </span>global_keyDownStates[PLATFORM_KEY_TOTAL_COUNT];  <br><br></div><br><a target='_blank' href='https://github.com/Olster1/windows_tutorials/tree/main/windows_keyboard_input/01%20version%20-%20just%20down%20or%20up'> You can see the code up to this point. ðŸ‘†</a><br><br><hr><h2><span id='id4'>Adding KeyPressed and KeyReleased</span></h2><br><p>
If we're not making a racing game, we're going to need the ability to see when the key was also pressed (true just on the frame the key is pressed) and released (true just on the frame when the user releases the key).</p>
<br><p>
To keep track of these two extra values, we'll store a struct per key in the array instead of just the bool.</p>
<br><div class="code-block-left "><span style="color: #CD950C;">struct </span>PlatformKeyState {<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>isDown;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>wasPressed;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>wasReleased;<br>};<br><br><span style="color: #CD950C;">static </span>PlatformKeyState global_keyDownStates[PLATFORM_KEY_TOTAL_COUNT];  <br><br></div><br><p>
In our message loop we now have to set these values:</p>
<br><div class="code-block-left "><span style="color: #7D7D7D;">//NOTE: We've added the z and x key, also a null type</span><br><span style="color: #CD950C;">enum </span>PlatformKeyType {<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_NULL,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_UP,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_DOWN,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_LEFT,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_RIGHT,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_Z,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_X,<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Everthing before here</span><br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_TOTAL_COUNT<br>};<br><br><span style="color: #CD950C;">static </span>PlatformKeyState global_keyDownStates[PLATFORM_KEY_TOTAL_COUNT];  <br><br>LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN || msg == WM_KEYUP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>keyDown <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;WPARAM vk_code = wparam;    	<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;PlatformKeyType keyType = PLATFORM_KEY_NULL; <br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: match our internal key names to the vk code</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_UP<span style="color: #A08563;">)</span> { <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_UP;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_DOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_DOWN;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_LEFT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_LEFT;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_RIGHT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_RIGHT;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == 'Z'<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_Z;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == 'X'<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_X;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Key pressed, key down and key release events  </span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>keyType != PLATFORM_KEY_NULL<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: We can use the last isDown state to see if it is a key press and key release</span><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Key press</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].wasPressed <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>keyDown && <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;!global_keyDownStates[keyType].isDown<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: key release</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].wasReleased <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>!keyDown && <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].isDown<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: set is down</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].isDown = keyDown;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br><br></div><br><p>
We use the last down state of the button to see if the key was up or down previously to this message, to find whether the message is a key press or key release.</p>
<br><p>
You'll see the letter VK codes are the uppercase character value of it. </p>
<br><p>
Now in the game code we can see whether a key was pressed and released, not just is down. This is handy for example, if you play as a wizard in your game and only want the player to cast a spell when they press the z key and not keep casting a spell while the key is down. </p>
<br><div class="code-block-left "><span style="color: #7D7D7D;">//NOTE: The Game Loop</span><br><span style="color: #6B8E23;">bool </span>running = true;<br><span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span>running<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Clear the key pressed and released so we only ever have it once per frame</span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">for</span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">int </span>i = <span style="color: #6B8E23;">0; </span>i &lt; PLATFORM_KEY_TOTAL_COUNT; ++i<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[i].wasPressed = false;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[i].wasReleased = false;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;MSG message;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span><span style="color: #CD950C;">PeekMessage</span><span style="color: #A08563;">(</span>&message, <span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span>PM_REMOVE<span style="color: #A08563;">)</span><span style="color: #A08563;">)</span><br>&emsp;&emsp;&emsp;&emsp;{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>message.message == WM_QUIT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Exit our game loop</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;running = false;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">TranslateMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">DispatchMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>; <span style="color: #7D7D7D;">//NOTE: our message callback is handled here</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Use our global array to access the key pressed state </span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>global_keyDownStates[PLATFORM_KEY_Z].wasPressed<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">castSpell</span><span style="color: #A08563;">(</span><span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br>}<br><br></div><br><p>
We're now succesfully handling pressed and released key events!</p>
<br><p>
You'll see we also set the <i>wasPressed</i> and <i>wasReleased</i> state to false at the <b>start of each frame before we process the messages</b>. This is because we only ever want the <i>wasPressed</i> and <i>wasReleased</i> value valid for one frame; if we don't clear the array and rely on a second WM_KEYDOWN message to set the values to false, the <i>wasPressed</i> value will be true for more than one frame (and a lot more) due to the repeat delay Windows and other Operating Systems use. The second message of a key being down won't come straight away but after a short interval.   </p>
<br><hr><h2><span id='id5'>Multiple Key Presses and Releases Per Frame</span></h2><br><p>
You might have noticed a caveat with our method. Since we process all messages since the last message loop at once, a user might have pressed the key twice since last frame. That means we would get a WM_KEYDOWN message, then a WM_KEYUP message then another WM_KEYDOWN message. But when we process the messages for that frame, we wouldn't know this since only the last message is relfected in our keystate for that frame[1]: we would just know in the frame that the key was pressed and is down, not that is was pressed and released before that. </p>
<br><p>
If the game is running at 60fps or 30fps this might not be a problem since the user and the keyboard has to register more than one key event in less than 0.016seconds. However if it is an esport game using a keyboard with a high scan rate [2] or a frame lags behind by a signficant amount we would want to take this into consideration. Instead of storing a bool for <i>wasPressed</i> and <i>wasReleased</i>, we're going to store an integer. </p>
<br><div class="code-block-left "><span style="color: #CD950C;">struct </span>PlatformKeyState {<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>isDown;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>pressedCount;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>releasedCount;<br>};<br><br></div><br><p>
At the start of each frame we're going to clear the pressed and released count for the last frame so we know we're starting from a clean slate. Let's do that.</p>
<br><div class="code-block-left "><span style="color: #7D7D7D;">//NOTE: The Game Loop</span><br><span style="color: #6B8E23;">bool </span>running = true;<br><span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span>running<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Clear the key pressed and released count before processing our messages</span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">for</span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">int </span>i = <span style="color: #6B8E23;">0; </span>i &lt; PLATFORM_KEY_TOTAL_COUNT; ++i<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[i].pressedCount = <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[i].releasedCount = <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;MSG message;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span><span style="color: #CD950C;">PeekMessage</span><span style="color: #A08563;">(</span>&message, <span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span>PM_REMOVE<span style="color: #A08563;">)</span><span style="color: #A08563;">)</span><br>&emsp;&emsp;&emsp;&emsp;{	<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>message.message == WM_QUIT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Exit our game loop</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;running = false;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">TranslateMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">DispatchMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>; <span style="color: #7D7D7D;">//NOTE: our message callback is handled here</span><br>&emsp;&emsp;&emsp;&emsp;}<br>}<br><br></div><br><p>
Now in our message callback we'll increment the count when we get a key press and key release.</p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN || msg == WM_KEYUP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>keyDown <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>msg == WM_KEYDOWN<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;WPARAM vk_code = wparam;    	<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;PlatformKeyType keyType = PLATFORM_KEY_NULL; <br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: match our internal key names to the vk code</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_UP<span style="color: #A08563;">)</span> { <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_UP;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_DOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_DOWN;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_LEFT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_LEFT;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_RIGHT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_RIGHT;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == 'Z'<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_Z;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == 'X'<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_X;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Key pressed, is down and release events  </span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>keyType != PLATFORM_KEY_NULL<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>wasPressed <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>keyDown && !global_keyDownStates[keyType].isDown<span style="color: #A08563;">)</span> ? <span style="color: #6B8E23;">1 </span>: <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>wasReleased <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>!keyDown && global_keyDownStates[keyType].isDown<span style="color: #A08563;">)</span> ? <span style="color: #6B8E23;">1 </span>: <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].pressedCount += wasPressed;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].releasedCount += wasReleased;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].isDown = keyDown;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br><br></div><br><p>
Now in the game code we can use the number of key presses instead of just a boolean. </p>
<br><div class="code-block-left "><span style="color: #7D7D7D;">//NOTE: The Game Loop</span><br><span style="color: #6B8E23;">bool </span>running = true;<br><span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span>running<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Clear the key pressed and released count before processing our messages</span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">for</span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">int </span>i = <span style="color: #6B8E23;">0; </span>i &lt; PLATFORM_KEY_TOTAL_COUNT; ++i<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[i].pressedCount = <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[i].releasedCount = <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;MSG message;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span><span style="color: #CD950C;">PeekMessage</span><span style="color: #A08563;">(</span>&message, <span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span>PM_REMOVE<span style="color: #A08563;">)</span><span style="color: #A08563;">)</span><br>&emsp;&emsp;&emsp;&emsp;{	<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>message.message == WM_QUIT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Exit our game loop</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;running = false;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">TranslateMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">DispatchMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>; <span style="color: #7D7D7D;">//NOTE: our message callback is handled here</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Cast the spell the number of times the user pressed the key in the last frame</span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">for</span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">int </span>i = <span style="color: #6B8E23;">0; </span>i &lt; global_keyDownStates[PLATFORM_KEY_Z].pressedCount; ++i<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">castSpell</span><span style="color: #A08563;">(</span><span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br>}<br><br></div><br><p>
We're now successfully handling multiple key press and releases per frame. To finish off key input we'll cover two more quick house keeping things. </p>
<br><hr><h2><span id='id6'>Handling WM_SYSKEYDOWN and WM_SYSKEYUP</span></h2><br><p>
We are also going to handle two other message types: WM_SYSKEYUP and WM_SYSKEYDOWN. This is the same as WM_KEYDOWN and WM_KEYUP but sent instead when the user is holding the ALT key down aswell. Since we would do any key modifiers ourself in our program, we'll handle both types of messages in the same way, irrespective of whether the user is holding ALT down.</p>
<br><p>
Let's put them in.</p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_SYSKEYDOWN || msg == WM_SYSKEYUP || <br>&emsp;&emsp;&emsp;&emsp;message == WM_KEYDOWN || message == WM_KEYUP<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: handle our keyboard input</span><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br></div><br><hr><h2><span id='id7'>Using lparam instead of previous <i>isDown</i> value</span>  </h2><br><p>
The current way we detect key presses is to rely on the previous <i>isDown</i> value to see if the incoming WM_KEYDOWN message is a representing a key press or just a repeated key down. If we like we don't have to rely on our previous key down state, as the incoming message comes with this in the lparam value. Specifically the 30th bit in the value is 1 if the key was down before the message is sent, or it is zero if the key was up. And the 30th bit is whether the key is up (value of 1) or down (value of 0). This is just a different way of doing it and provides no extra benefits.</p>
<br><a target='_blank' href='https://docs.microsoft.com/en-us/windows/win32/inputdev/wm-keydown'> You can read more about the message WM_KEYDOWN here and what the incoming parameters correspond to ðŸ‘†</a><br><br><a target='_blank' href='https://docs.microsoft.com/en-us/windows/win32/inputdev/wm-keyup'> Same but for WM_KEYUP ðŸ‘†</a><br><br><p>
Our message callback would now look like this. </p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_SYSKEYDOWN || msg == WM_SYSKEYUP || <br>&emsp;&emsp;&emsp;&emsp;message == WM_KEYDOWN || message == WM_KEYUP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>keyWasDown <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span><span style="color: #A08563;">(</span>l_param <span style="color: #CD950C;">& </span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">1 </span>&lt;&lt; <span style="color: #6B8E23;">30</span><span style="color: #A08563;">)</span><span style="color: #A08563;">)</span> == <span style="color: #6B8E23;">0</span><span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>keyIsDown =   <span style="color: #CD950C;">!</span><span style="color: #A08563;">(</span>l_param <span style="color: #CD950C;">& </span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">1 </span>&lt;&lt; <span style="color: #6B8E23;">31</span><span style="color: #A08563;">)</span><span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;WPARAM vk_code = wparam;    	<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;PlatformKeyType keyType = PLATFORM_KEY_NULL; <br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: match our internal key names to the vk code</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_UP<span style="color: #A08563;">)</span> { <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_UP;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_DOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_DOWN;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_LEFT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_LEFT;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_RIGHT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_RIGHT;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == 'Z'<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_Z;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == 'X'<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_X;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Key pressed, is down and release events  </span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>keyType != PLATFORM_KEY_NULL<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>wasPressed <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>keyIsDown && !keyWasDown<span style="color: #A08563;">)</span> ? <span style="color: #6B8E23;">1 </span>: <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>wasReleased <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>!keyIsDown<span style="color: #A08563;">)</span> ? <span style="color: #6B8E23;">1 </span>: <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].pressedCount += wasPressed;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].releasedCount += wasReleased;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[keyType].isDown = keyIsDown;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br></div><br><hr><h2><span id='id8'>Mouse Input</span></h2><br><p>
Now that we've got our key input the next thing we want to do is handle mouse input. We're going to handle it similar to our key input, we just have to handle different messages: WM_LBUTTONDOWN, WM_LBUTTONUP, WM_RBUTTONDOWN, WM_RBUTTONUP, WM_MOUSEWHEEL and WM_MOUSEHWHEEL. Let's do this!</p>
<br><p>
First we'll add some extra key states to our enum. And two float values to store the scroll value.</p>
<br><div class="code-block-left "><span style="color: #CD950C;">enum </span>PlatformKeyType {<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_NULL,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_UP,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_DOWN,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_LEFT,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_RIGHT,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_Z,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_X,<br><br>&emsp;&emsp;&emsp;&emsp;PLATFORM_MOUSE_LEFT_BUTTON,<br>&emsp;&emsp;&emsp;&emsp;PLATFORM_MOUSE_RIGHT_BUTTON,<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Everthing before here</span><br>&emsp;&emsp;&emsp;&emsp;PLATFORM_KEY_TOTAL_COUNT<br>};<br><br><span style="color: #CD950C;">static </span><span style="color: #6B8E23;">float </span>global_mouseScrollY;<br><span style="color: #CD950C;">static </span><span style="color: #6B8E23;">float </span>global_mouseScrollX;<br><br></div><br><p>
Now in our message callback we will set the values.</p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_LBUTTONDOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>!global_keyDownStates[PLATFORM_MOUSE_LEFT_BUTTON].isDown<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_MOUSE_LEFT_BUTTON].pressedCount++;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_MOUSE_LEFT_BUTTON].isDown = true;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_LBUTTONUP<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_MOUSE_LEFT_BUTTON].releasedCount++;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_MOUSE_LEFT_BUTTON].isDown = false;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_RBUTTONDOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>!global_keyDownStates[PLATFORM_MOUSE_RIGHT_BUTTON].isDown<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_MOUSE_RIGHT_BUTTON].pressedCount++;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_MOUSE_RIGHT_BUTTON].isDown = true;<br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_RBUTTONUP<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_MOUSE_RIGHT_BUTTON].releasedCount++;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[PLATFORM_MOUSE_RIGHT_BUTTON].isDown = false;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_MOUSEWHEEL<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: We use the HIWORD macro defined in windows.h to get the high 16 bits</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;short wheel_delta = <span style="color: #CD950C;">HIWORD</span><span style="color: #A08563;">(</span>wparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_mouseScrollY <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #A08563;">)</span>wheel_delta;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_MOUSEHWHEEL<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: We use the HIWORD macro defined in windows.h to get the high 16 bits</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;short wheel_delta = <span style="color: #CD950C;">HIWORD</span><span style="color: #A08563;">(</span>wparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_mouseScrollX <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #A08563;">)</span>wheel_delta;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_SYSKEYDOWN || msg == WM_SYSKEYUP || <br>&emsp;&emsp;&emsp;&emsp;message == WM_KEYDOWN || message == WM_KEYUP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Handling our key presses here </span><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//....</span><br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} <br><br><br></div><br><hr><h2><span id='id9'>Get Cursor Coordinates</span></h2><br><p>
Great, we're handling mouse input. The last thing to fully handle the mouse is to retrieve the x, y coordinates of it. There isn't a message for this, we just query it each frame in our game loop. The code do this looks like this:</p>
<br><div class="code-block-left ">POINT mouse;<br><span style="color: #CD950C;">GetCursorPos</span><span style="color: #A08563;">(</span>&mouse<span style="color: #A08563;">)</span>;<br><span style="color: #7D7D7D;">//NOTE: hwnd is the window handle passed into our WinMain function</span><br><span style="color: #CD950C;">ScreenToClient</span><span style="color: #A08563;">(</span>hwnd, &mouse<span style="color: #A08563;">)</span>;<br><span style="color: #6B8E23;">float </span>mouseX <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #CD950C;">)</span><span style="color: #A08563;">(</span>mouse.x<span style="color: #A08563;">)</span>;<br><span style="color: #6B8E23;">float </span>mouseY <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #CD950C;">)</span><span style="color: #A08563;">(</span>mouse.y<span style="color: #A08563;">)</span>;<br><br></div><br><p>
In the game loop we'll put it after our message loop. </p>
<br><div class="code-block-left "><span style="color: #7D7D7D;">//NOTE: The Game Loop</span><br><span style="color: #6B8E23;">bool </span>running = true;<br><span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span>running<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Clear the key pressed and released count before processing our messages</span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">for</span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">int </span>i = <span style="color: #6B8E23;">0; </span>i &lt; PLATFORM_KEY_TOTAL_COUNT; ++i<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[i].pressedCount = <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_keyDownStates[i].releasedCount = <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;MSG message;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">while</span><span style="color: #A08563;">(</span><span style="color: #CD950C;">PeekMessage</span><span style="color: #A08563;">(</span>&message, <span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span><span style="color: #6B8E23;">0, </span>PM_REMOVE<span style="color: #A08563;">)</span><span style="color: #A08563;">)</span><br>&emsp;&emsp;&emsp;&emsp;{	<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>message.message == WM_QUIT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Exit our game loop</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;running = false;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">TranslateMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">DispatchMessage</span><span style="color: #A08563;">(</span>&message<span style="color: #A08563;">)</span>; <span style="color: #7D7D7D;">//NOTE: our message callback is handled here</span><br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: get the mouse location</span><br>&emsp;&emsp;&emsp;&emsp;POINT mouse;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">GetCursorPos</span><span style="color: #A08563;">(</span>&mouse<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: hwnd is the window handle passed into our WinMain function</span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">ScreenToClient</span><span style="color: #A08563;">(</span>hwnd, &mouse<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseX <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #CD950C;">)</span><span style="color: #A08563;">(</span>mouse.x<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseY <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #CD950C;">)</span><span style="color: #A08563;">(</span>mouse.y<span style="color: #A08563;">)</span>;<br><br>}<br><br></div><br><p>
GetCursorPos retrieves the mouse location relative to the computer screen with the origin in the bottom left corner. We then use ScreenToClient to map the coordinates to be relative to the bottom left corner of our window.</p>
<br><hr><h2><span id='id10'>Platform Input Struct</span></h2><br><p>
Well done, we did it. We're handling key input, mouse input and cursor location. To clean things up, instead of having multiple global variables, let's just put all the input into one struct.</p>
<br><div class="code-block-left "><span style="color: #CD950C;">struct </span>PlatformInputState {<br><br>&emsp;&emsp;&emsp;&emsp;PlatformKeyState keyStates[PLATFORM_KEY_TOTAL_COUNT]; <br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Mouse data</span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseX;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseY;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseScrollX;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseScrollY;<br>}	<br><br><span style="color: #CD950C;">static </span>PlatformInputState global_platformInput;<br><br></div><br><p>
We'll then change our code to use this inputState instead of the seperate global variables. It's all the same as before just now accessing the array and mouseScroll values from the PlatformStruct. Our message callback will look like this.</p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_CLOSE || msg == WM_DESTROY<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">PostQuitMessage</span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">0</span><span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_LBUTTONDOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>!global_platformInput.keyStates[PLATFORM_MOUSE_LEFT_BUTTON].isDown<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[PLATFORM_MOUSE_LEFT_BUTTON].pressedCount++;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[PLATFORM_MOUSE_LEFT_BUTTON].isDown = true;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_LBUTTONUP<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[PLATFORM_MOUSE_LEFT_BUTTON].releasedCount++;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[PLATFORM_MOUSE_LEFT_BUTTON].isDown = false;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_RBUTTONDOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>!global_platformInput.keyStates[PLATFORM_MOUSE_RIGHT_BUTTON].isDown<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[PLATFORM_MOUSE_RIGHT_BUTTON].pressedCount++;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[PLATFORM_MOUSE_RIGHT_BUTTON].isDown = true;<br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_RBUTTONUP<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[PLATFORM_MOUSE_RIGHT_BUTTON].releasedCount++;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[PLATFORM_MOUSE_RIGHT_BUTTON].isDown = false;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_MOUSEWHEEL<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: We use the HIWORD macro defined in windows.h to get the high 16 bits</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;short wheel_delta = <span style="color: #CD950C;">HIWORD</span><span style="color: #A08563;">(</span>wparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.mouseScrollY <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #A08563;">)</span>wheel_delta;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_MOUSEHWHEEL<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: We use the HIWORD macro defined in windows.h to get the high 16 bits</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;short wheel_delta = <span style="color: #CD950C;">HIWORD</span><span style="color: #A08563;">(</span>wparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.mouseScrollX <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #A08563;">)</span>wheel_delta;<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_SYSKEYDOWN || msg == WM_SYSKEYUP || <br>&emsp;&emsp;&emsp;&emsp;message == WM_KEYDOWN || message == WM_KEYUP<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Handling our key presses here </span><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>keyWasDown <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span><span style="color: #A08563;">(</span>l_param <span style="color: #CD950C;">& </span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">1 </span>&lt;&lt; <span style="color: #6B8E23;">30</span><span style="color: #A08563;">)</span><span style="color: #A08563;">)</span> == <span style="color: #6B8E23;">0</span><span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">bool </span>keyIsDown =   <span style="color: #CD950C;">!</span><span style="color: #A08563;">(</span>l_param <span style="color: #CD950C;">& </span><span style="color: #A08563;">(</span><span style="color: #6B8E23;">1 </span>&lt;&lt; <span style="color: #6B8E23;">31</span><span style="color: #A08563;">)</span><span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;WPARAM vk_code = wparam;    	<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;PlatformKeyType keyType = PLATFORM_KEY_NULL; <br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: match our internal key names to the vk code</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_UP<span style="color: #A08563;">)</span> { <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_UP;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_DOWN<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_DOWN;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_LEFT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_LEFT;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == VK_RIGHT<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_RIGHT;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == 'Z'<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_Z;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>vk_code == 'X'<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;keyType = PLATFORM_KEY_X;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Key pressed, is down and release events  </span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>keyType != PLATFORM_KEY_NULL<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>wasPressed <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>keyIsDown && !keyWasDown<span style="color: #A08563;">)</span> ? <span style="color: #6B8E23;">1 </span>: <span style="color: #6B8E23;">0;</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>wasReleased <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>!keyIsDown<span style="color: #A08563;">)</span> ? <span style="color: #6B8E23;">1 </span>: <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[keyType].pressedCount += wasPressed;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[keyType].releasedCount += wasReleased;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.keyStates[keyType].isDown = keyIsDown;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span>{<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;result = <span style="color: #CD950C;">DefWindowProcW</span><span style="color: #A08563;">(</span>hwnd, msg, wparam, lparam<span style="color: #A08563;">)</span>;<br>&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">return </span>result;<br>} 	<br><br></div><br><p>
And our mouse position will use this as well to store it's values.</p>
<br><div class="code-block-left "><span style="color: #7D7D7D;">//In our game loop</span><br><br><span style="color: #7D7D7D;">//NOTE: get the mouse location</span><br>POINT mouse;<br><span style="color: #CD950C;">GetCursorPos</span><span style="color: #A08563;">(</span>&mouse<span style="color: #A08563;">)</span>;<br><span style="color: #7D7D7D;">//NOTE: hwnd is the window handle passed into our WinMain function</span><br><span style="color: #CD950C;">ScreenToClient</span><span style="color: #A08563;">(</span>hwnd, &mouse<span style="color: #A08563;">)</span>;<br>global_platformInput.mouseX <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #CD950C;">)</span><span style="color: #A08563;">(</span>mouse.x<span style="color: #A08563;">)</span>;<br>global_platformInput.mouseY <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>float<span style="color: #CD950C;">)</span><span style="color: #A08563;">(</span>mouse.y<span style="color: #A08563;">)</span>;<br><br></div><br><hr><h2>Creating a character buffer for text input</h2><br><p>
In a game you might want an actual string of characters that a user typed like entering in their profile name or entering commands into the in-game console. For this you want to handle the messages a bit different for three reasons:</p>
<br><p>
1. So it obeys the keyboard repeat functionality (if you just used the <i>isDown</i> for a key, it would spew out be very hard to control the number of letters coming out because it's just down every frame). </p>
<br><p>
2. To handle unicode characters - virtual key codes don't contain unicode </p>
<br><p>
3. For the OS to handle Upper case and Lower case for us</p>
<br><p>
To do this we use the WM_CHAR message. Each time we get this message we add the character to a buffer for that frame. </p>
<br><p>
We'll store the buffer in our PlatformInputState.</p>
<br><div class="code-block-left "><span style="color: #DAB98F;">#define </span>PLATFORM_MAX_TEXT_BUFFER_SIZE_IN_BYTES <span style="color: #6B8E23;">256</span><br><br><span style="color: #CD950C;">struct </span>PlatformInputState {<br><br>&emsp;&emsp;&emsp;&emsp;PlatformKeyState keyStates[PLATFORM_KEY_TOTAL_COUNT]; <br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Mouse data</span><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseX;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseY;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseScrollX;<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">float </span>mouseScrollY;<br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Text Input</span><br>&emsp;&emsp;&emsp;&emsp;uint8_t textInput_utf8[PLATFORM_MAX_TEXT_BUFFER_SIZE_IN_BYTES];<br>&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>textInput_bytesUsed;<br>}	<br><br><span style="color: #CD950C;">static </span>PlatformInputState global_platformInput;<br><br></div><br><p>
Then in our message loop we'll handle the WM_CHAR message:</p>
<br><div class="code-block-left ">LRESULT CALLBACK <span style="color: #CD950C;">WndProc</span><span style="color: #A08563;">(</span>HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;LRESULT result = <span style="color: #6B8E23;">0;</span><br><br>&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span>msg == WM_CHAR<span style="color: #A08563;">)</span> {<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;uint32_t utf16_character <span style="color: #CD950C;">= </span><span style="color: #A08563;">(</span>uint32_t<span style="color: #A08563;">)</span>wparam;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Convert the utf16 character to utf8</span><br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Get the size of the utf8 character in bytes</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">int </span>bufferSize_inBytes = <span style="color: #CD950C;">WideCharToMultiByte</span><span style="color: #A08563;">(</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;CP_UTF8,<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">0,</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;utf16_character,<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">1, </span><span style="color: #7D7D7D;">//NOTE: character not null terminated, so specify it's only one character long</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #A08563;">(</span>LPSTR<span style="color: #A08563;">)</span>global_platformInput.textInput_utf8, <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">0,</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">0, </span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">0</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: See if we can still fit the character in our buffer</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #CD950C;">if</span><span style="color: #A08563;">(</span><span style="color: #A08563;">(</span>global_platformInput.textInput_bytesUsed + bufferSize_inBytes<span style="color: #A08563;">)</span> &lt;= PLATFORM_MAX_TEXT_BUFFER_SIZE_IN_BYTES<span style="color: #A08563;">)</span> {<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Add the utf8 value of the character to our buffer</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">u32 </span>bytesWritten = <span style="color: #CD950C;">WideCharToMultiByte</span><span style="color: #A08563;">(</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;CP_UTF8,<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">0,</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;utf16_character,<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">-1,</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #A08563;">(</span>LPSTR<span style="color: #CD950C;">)</span><span style="color: #A08563;">(</span>global_platformInput.textInput_utf8 + global_platformInput.textInput_bytesUsed<span style="color: #A08563;">)</span>, <br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;bufferSize_inBytes,<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">0, </span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #6B8E23;">0</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #A08563;">)</span>;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span style="color: #7D7D7D;">//NOTE: Increment the buffer size</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;global_platformInput.textInput_bytesUsed += bufferSize_inBytes;<br><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}<br><br>&emsp;&emsp;&emsp;&emsp;} <span style="color: #CD950C;">else </span><span style="color: #7D7D7D;">//... rest of our messages</span><br><br><br><br></div><br><p>
We get the character code from the wparam. This is a utf-16 encoded character. Depending on how you'll use this string you'll want to convert it to it's utf-8 equivalent. We use the windows function <i>WideCharToMultiByte</i> to do this for us. We first get the size of the utf-8 character in bytes, then if it fits in our buffer, we'll convert it, putting the result in our buffer.  </p>
<br><h2>NOTES</h2><br><p>
[1] If we're really processing only the last message that we recieved each frame, wouldn't we get multiple WM_KEYDOWN messages in a frame when we start pressing a key? Causing us to not register any key press events? Luckily, Windows and most Operating Systems has a Keyboard Repeat functionality causing a slight delay between the first WM_KEYDOWN message of a key press and subsequent WM_KEYDOWN messages. This means in a single frame, it's unlikely we will see a second WM_KEYDOWN message for a key press.</p>
<br><p>
[2] You can test your keyboard scan rate <a href=https://blog.seethis.link/scan-rate-estimator/> at this link </a>. <a href='https://www.reddit.com/r/MechanicalKeyboards/comments/k2mb4x/keyboard_polling_ratescan_rate_help/'>The answer on this thread gives a detailed explanation on Poll Rate vs Scan Rate of a keyboard.</a></p>
<br></div>
</div>
</div>
<br><br></div></body></html>